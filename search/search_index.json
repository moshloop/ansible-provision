{"config":{"lang":["en"],"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Getting Started ansible-provision is part of suite of ansible roles that provide a common interface for provisioning infrastructure. While there is a slant towards AWS services many interfaces support vmware vCenter and Azure. Design Principles Convention over configuration - Require as minimal configuration as possible, lookup ids in the background and use conventions whenever possible Prefer declarative template (e.g. AWS Cloudformation / Azure Resource Templates) to direct API calls Use cloud-init extensively to setup volumes and bootstrap instances for deployment. Dependencies ansible ansible-deploy is used to generate cloudinit config files for bootrapping instances once they have been provisioned. ansible-deploy shares many of the same interfaces as ansible-provision so that for example an EBS volume can be provisioned and then formatted and mounted it into the filesystem on startup. systools provides many helpers and bootstraping tools (systools will be installed by ansible-deploy if it is missing) fireviz is a tool to convert Graphviz firewall diagrams into Cloudformation/ARM templates (Optional) ansible-dependencies provides RPM, DEB and pip packages that simplify the installation of ansible with all the required dependencies to use cloud and networking modules (Optional) ansible-run provides CLI tools for easily running and testing ansible playbooks using ansible-dependencies. Quickstart with Virtual Box Install Virtual Box and create a VM named \"Ubuntu_Template\" Create an inventory file under inventory/group_vars/all.yml 1 2 target : virtualbox template : Ubuntu_Template Install the CLI: pip install ansible-provision Provision an instance: ansible-provision --hostname test_instance Targets Target Description aws Generates and then executes CloudFormation templates for each ansible group aws-service-catalog Similar to aws but instead of creating an instance it creates a service catalog product azure Generates Azure Resource Templates and then executes them vmware Creates VM's using the native ansible VMware modules and vCenter / vSphere vmware-fusion Clones VM's using the vmrun CLI included with \u0005VMware Fusion VirtualBox Clones VM's using the VBoxManage CLI included with VirtualBox Pinning Versions Both ansible-provision and ansible-deploy can be pinned to specific versions at an inventory level, rather than at an installation level. This works by checking out specific tags or branches just before running the role: inventory/group_vars/all.yml 1 2 ansible_deploy_version : 2.9.2 ansible_provision_version : 4.1 Sample Folder Structure 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u251c\u2500\u2500 cloudformation # applies to AWS only \u2502 \u2514\u2500\u2500 iam.cf \u251c\u2500\u2500 firewall \u2502 \u251c\u2500\u2500 all.gv \u2502 \u2514\u2500\u2500 mapping.yml \u251c\u2500\u2500 inventory \u2502 \u251c\u2500\u2500 group_vars \u2502 \u2502 \u251c\u2500\u2500 all \u2502 \u2502 \u251c\u2500\u2500 app \u2502 \u2502 \u251c\u2500\u2500 db \u2502 \u2502 \u251c\u2500\u2500 dev \u2502 \u2502 \u251c\u2500\u2500 test \u2502 \u2502 \u2514\u2500\u2500 web \u2502 \u2514\u2500\u2500 hosts \u251c\u2500\u2500 play.yml \u2514\u2500\u2500 roles \u2514\u2500\u2500 requirements.yml","title":"Getting Started"},{"location":"#getting-started","text":"ansible-provision is part of suite of ansible roles that provide a common interface for provisioning infrastructure. While there is a slant towards AWS services many interfaces support vmware vCenter and Azure.","title":"Getting Started"},{"location":"#design-principles","text":"Convention over configuration - Require as minimal configuration as possible, lookup ids in the background and use conventions whenever possible Prefer declarative template (e.g. AWS Cloudformation / Azure Resource Templates) to direct API calls Use cloud-init extensively to setup volumes and bootstrap instances for deployment.","title":"Design Principles"},{"location":"#dependencies","text":"ansible ansible-deploy is used to generate cloudinit config files for bootrapping instances once they have been provisioned. ansible-deploy shares many of the same interfaces as ansible-provision so that for example an EBS volume can be provisioned and then formatted and mounted it into the filesystem on startup. systools provides many helpers and bootstraping tools (systools will be installed by ansible-deploy if it is missing) fireviz is a tool to convert Graphviz firewall diagrams into Cloudformation/ARM templates (Optional) ansible-dependencies provides RPM, DEB and pip packages that simplify the installation of ansible with all the required dependencies to use cloud and networking modules (Optional) ansible-run provides CLI tools for easily running and testing ansible playbooks using ansible-dependencies.","title":"Dependencies"},{"location":"#quickstart-with-virtual-box","text":"Install Virtual Box and create a VM named \"Ubuntu_Template\" Create an inventory file under inventory/group_vars/all.yml 1 2 target : virtualbox template : Ubuntu_Template Install the CLI: pip install ansible-provision Provision an instance: ansible-provision --hostname test_instance","title":"Quickstart with Virtual Box"},{"location":"#targets","text":"Target Description aws Generates and then executes CloudFormation templates for each ansible group aws-service-catalog Similar to aws but instead of creating an instance it creates a service catalog product azure Generates Azure Resource Templates and then executes them vmware Creates VM's using the native ansible VMware modules and vCenter / vSphere vmware-fusion Clones VM's using the vmrun CLI included with \u0005VMware Fusion VirtualBox Clones VM's using the VBoxManage CLI included with VirtualBox","title":"Targets"},{"location":"#pinning-versions","text":"Both ansible-provision and ansible-deploy can be pinned to specific versions at an inventory level, rather than at an installation level. This works by checking out specific tags or branches just before running the role: inventory/group_vars/all.yml 1 2 ansible_deploy_version : 2.9.2 ansible_provision_version : 4.1","title":"Pinning Versions"},{"location":"#sample-folder-structure","text":"1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u251c\u2500\u2500 cloudformation # applies to AWS only \u2502 \u2514\u2500\u2500 iam.cf \u251c\u2500\u2500 firewall \u2502 \u251c\u2500\u2500 all.gv \u2502 \u2514\u2500\u2500 mapping.yml \u251c\u2500\u2500 inventory \u2502 \u251c\u2500\u2500 group_vars \u2502 \u2502 \u251c\u2500\u2500 all \u2502 \u2502 \u251c\u2500\u2500 app \u2502 \u2502 \u251c\u2500\u2500 db \u2502 \u2502 \u251c\u2500\u2500 dev \u2502 \u2502 \u251c\u2500\u2500 test \u2502 \u2502 \u2514\u2500\u2500 web \u2502 \u2514\u2500\u2500 hosts \u251c\u2500\u2500 play.yml \u2514\u2500\u2500 roles \u2514\u2500\u2500 requirements.yml","title":"Sample Folder Structure"},{"location":"ansible-addons/","text":"Ansible Role for creating systemd services, for managing existing services use the built-in systemd module. Filters name description file_exists (path) dir_exists (path) jsonpath (data) transforms data using jsonpath_rw nestedelement (path) Returns an nested element from an object tree by path (seperated by / or .) play_groups (play_hosts, groups, hostvars) Returns a list of groups that are active within a play split (string, separator=' ') to_map (map, key, value) walk_up (object, path) Walks up an object tree from the lowest level collecting all attributes not available at lower levels map_to_entries (dict, key, value) Convert a dict into a list of entries Modules cloudinit_iso 1 2 3 4 5 6 7 8 - cloudinit_iso : dest : \"{{playbook_dir}}/cloudinit.iso\" user : | #cloud-config preserve_hostname: true hostname: ansible-hostname users: - name: hostname Note cloudinit_iso requires the genisoimage package to be installed.","title":"ansible-extras"},{"location":"ansible-addons/#filters","text":"name description file_exists (path) dir_exists (path) jsonpath (data) transforms data using jsonpath_rw nestedelement (path) Returns an nested element from an object tree by path (seperated by / or .) play_groups (play_hosts, groups, hostvars) Returns a list of groups that are active within a play split (string, separator=' ') to_map (map, key, value) walk_up (object, path) Walks up an object tree from the lowest level collecting all attributes not available at lower levels map_to_entries (dict, key, value) Convert a dict into a list of entries","title":"Filters"},{"location":"ansible-addons/#modules","text":"","title":"Modules"},{"location":"ansible-addons/#cloudinit_iso","text":"1 2 3 4 5 6 7 8 - cloudinit_iso : dest : \"{{playbook_dir}}/cloudinit.iso\" user : | #cloud-config preserve_hostname: true hostname: ansible-hostname users: - name: hostname Note cloudinit_iso requires the genisoimage package to be installed.","title":"cloudinit_iso"},{"location":"aws/","text":"AWS The AWS provisioning lifecycle uses ansible to generate cloudformation - there are some runtime arguments that can be used to reduce the aggressiveness of the Cloudformation replacement rules. Dependencies First setup the environment with AWS access credentials, either via ~/.aws/credentials , AWS_ACCESS_KEY environment variable, or an IAM instance profile. Create the VPC and subnet infrastracture - either via cloudformation in the cloudformation directory or manually. Ensure all subnet's have Name tags which are used to lookup subnet-ids based on subnet_name Setup 1 2 3 region : eu-west-1 account_id : 1234 vpc_id : vpc-223 Options Config Default Description account_id AWS Account ID region AWS region vpc_id domain domain that is used for internal DNS lookup domain_id security_groups default {{role}} {{role}}-{{purpose}} A list of security group names to apply default_ssl_certificate self_signed_default name to use for the self signed SSL placeholder elbs a list of groups that include elb's Runtime Arguments Pass runtime arguments using -e e.g. -e ami_update=true or save on a per host / group level Argument Default Description ami_update false Set to false to disable updating the AMI, causing the instance to be terminated and be re-created userData_update false Set to false to disable updating the user-data which would normally cause instances to be restarted boot_disk_update false create_change_set true","title":"AWS"},{"location":"aws/#aws","text":"The AWS provisioning lifecycle uses ansible to generate cloudformation - there are some runtime arguments that can be used to reduce the aggressiveness of the Cloudformation replacement rules.","title":"AWS"},{"location":"aws/#dependencies","text":"First setup the environment with AWS access credentials, either via ~/.aws/credentials , AWS_ACCESS_KEY environment variable, or an IAM instance profile. Create the VPC and subnet infrastracture - either via cloudformation in the cloudformation directory or manually. Ensure all subnet's have Name tags which are used to lookup subnet-ids based on subnet_name","title":"Dependencies"},{"location":"aws/#setup","text":"1 2 3 region : eu-west-1 account_id : 1234 vpc_id : vpc-223","title":"Setup"},{"location":"aws/#options","text":"Config Default Description account_id AWS Account ID region AWS region vpc_id domain domain that is used for internal DNS lookup domain_id security_groups default {{role}} {{role}}-{{purpose}} A list of security group names to apply default_ssl_certificate self_signed_default name to use for the self signed SSL placeholder elbs a list of groups that include elb's","title":"Options"},{"location":"aws/#runtime-arguments","text":"Pass runtime arguments using -e e.g. -e ami_update=true or save on a per host / group level Argument Default Description ami_update false Set to false to disable updating the AMI, causing the instance to be terminated and be re-created userData_update false Set to false to disable updating the user-data which would normally cause instances to be restarted boot_disk_update false create_change_set true","title":"Runtime Arguments"},{"location":"azure/","text":"Options Config Default Description account_id Azure subscription id infra_resource_group Resource group for the network resource_group Resource group for VM's region vpc_id az_managed boot_diag_uri backup_vault public_ip security_groups default {{role}} {{role}}-{{purpose}} A list of security group names to apply image OR image_publisher RedHat image_offer RHEL image_sku 7.5 image_version latest","title":"Azure"},{"location":"azure/#options","text":"Config Default Description account_id Azure subscription id infra_resource_group Resource group for the network resource_group Resource group for VM's region vpc_id az_managed boot_diag_uri backup_vault public_ip security_groups default {{role}} {{role}}-{{purpose}} A list of security group names to apply image OR image_publisher RedHat image_offer RHEL image_sku 7.5 image_version latest","title":"Options"},{"location":"customization/","text":"","title":"Customization"},{"location":"firewall/","text":"Firewalls ansible-provision uses fireviz to map and create security groups: firewall.gv 1 2 3 4 5 6 7 digraph G { node[shape=rectangle] \"Internet\" -> \"ELB\" [xlabel=\"80,443\"] \"ELB\" -> \"Web\" [xlabel=\"80,443\"] \"App\" -> \"DB\" [xlabel=\"5432\"] } to generate an image use: dot firewall.gv -Tpng -o firewall.png","title":"Firewalls"},{"location":"firewall/#firewalls","text":"ansible-provision uses fireviz to map and create security groups: firewall.gv 1 2 3 4 5 6 7 digraph G { node[shape=rectangle] \"Internet\" -> \"ELB\" [xlabel=\"80,443\"] \"ELB\" -> \"Web\" [xlabel=\"80,443\"] \"App\" -> \"DB\" [xlabel=\"5432\"] } to generate an image use: dot firewall.gv -Tpng -o firewall.png","title":"Firewalls"},{"location":"load-balancing/","text":"Loadbalancers Application Load Balancer 1 2 3 elb : - { port : '8443' , type : https , alb : true } - { port : '8080' , type : http , alb : true } Classic Load Balancer 1 2 3 elb : - { port : '8443' , type : https } - { port : '8080' , type : http } Public load balancers 1 2 3 elb : - { port : '8443' , type : https , scheme : 'internet-facing' } - { port : '8080' , type : http , scheme : 'internet-facing' } Name Default Description port type http http,https,tcp check {port}/ alb false Create a Application Load Balancer instead of classic checkPath / ALB only: checkPort {port} ALB only: checkType {type} ALB only: unhealthyCount 3 healthyCount 5 timeout 10 Timeout in seconds internal 30 Check interval in seconds code 200 ALB only sslId {default_ssl_arn} ACM or IAM SSL certificate arn alias {group_name} security_group subnet_name stickiness false scheme internal internal or internet-facing","title":"Load Balancing"},{"location":"load-balancing/#loadbalancers","text":"Application Load Balancer 1 2 3 elb : - { port : '8443' , type : https , alb : true } - { port : '8080' , type : http , alb : true } Classic Load Balancer 1 2 3 elb : - { port : '8443' , type : https } - { port : '8080' , type : http } Public load balancers 1 2 3 elb : - { port : '8443' , type : https , scheme : 'internet-facing' } - { port : '8080' , type : http , scheme : 'internet-facing' } Name Default Description port type http http,https,tcp check {port}/ alb false Create a Application Load Balancer instead of classic checkPath / ALB only: checkPort {port} ALB only: checkType {type} ALB only: unhealthyCount 3 healthyCount 5 timeout 10 Timeout in seconds internal 30 Check interval in seconds code 200 ALB only sslId {default_ssl_arn} ACM or IAM SSL certificate arn alias {group_name} security_group subnet_name stickiness false scheme internal internal or internet-facing","title":"Loadbalancers"},{"location":"reference/","text":"Option Description AWS Azure vSphere ami Image name alias: template region alias: datacenter az Availability zone alias: cluster cpu Number of cores, Default: 2 \u2716 \u2716 mem GB of memory, Default: 2 \u2716 \u2716 instance_type \u2716 Use mem and cpu subnet_name alias: vlan tags, all_tags Map of tags Volumes boot_disk_size boot_disk_type gp2 \u2716 \u2716 data_volume_size Shorthand for creating a default data volume instance_volumes \u2716 \u2716 volumes List of volumes Security instance_role IAM Instance Role \u2716 \u2716 security_groups List of security group names \u2716 \u2716 ssh_key_full ssh_key_name AWS SSH Key Pair Name \u2716 \u2716 ssh_key_user Defaults to: ec2-user Bootstrapping phone_home List of commands to run on startup Load Balancing elbs List of group names to create load balancers for \u2716 \u2716","title":"Reference"},{"location":"vmware/","text":"VMWare VMWare provisioning is done via the vCenter api's and a cloud-init script that is bundled into an ISO (per VM). You first need to create a base VM template or image to use for cloning from: 1 2 3 4 5 6 7 8 9 target : vmware template : BASE_TEMPLATE vcenter_hostname : vcenter_username : vcenter_password : region : dc1 az : cluster1 #Specify either the VLAN ID or switch name subnet_name : 1 Options Config Default Description datacenter alias: region cluster alias: az vlan alias: subnet_name vcenter_hostname vcenter_username vcenter_password vm_groups vm_attributes alias: tags datastore","title":"vmware"},{"location":"vmware/#vmware","text":"VMWare provisioning is done via the vCenter api's and a cloud-init script that is bundled into an ISO (per VM). You first need to create a base VM template or image to use for cloning from: 1 2 3 4 5 6 7 8 9 target : vmware template : BASE_TEMPLATE vcenter_hostname : vcenter_username : vcenter_password : region : dc1 az : cluster1 #Specify either the VLAN ID or switch name subnet_name : 1","title":"VMWare"},{"location":"vmware/#options","text":"Config Default Description datacenter alias: region cluster alias: az vlan alias: subnet_name vcenter_hostname vcenter_username vcenter_password vm_groups vm_attributes alias: tags datastore","title":"Options"},{"location":"volumes/","text":"Storage Volumes 1 2 volumes : - {} Name Default Description size Size in GB of the volume id The name of the volume e.g. volume it will be used as suffix dev The unique device path to use e.g. /dev/xvf , host:/nfs_mount type gp2 format Optional: Partition type e.g. xfs , lvm , nfs mount Optional: Mount point for the volume e.g. /mnt/volume LVM LVM volumes are supported are supported: To create an physical volume specify format: lvm and the volume name under mount: VolName Then add another volume with dev: VolName Example: create a 200GB volume called VolData, format it with xfs and then mount under /pgdata 1 2 3 volumes : - { size : 201 , id : data , dev : /dev/xvdf , format : lvm , mount : VolData } - { size : 200 , id : data-pgdata , dev : VolData , format : xfs , mount : /pgdata } Example: Creating 3 LVM volumes for Postgres 1 2 3 4 5 6 7 volumes : - { size : 201 , id : data , dev : /dev/xvdf , format : lvm , mount : VolData } - { size : 200 , id : data-pgdata , dev : VolData , format : xfs , mount : /pgdata } - { size : 101 , id : backups , dev : /dev/xvdg , format : lvm , mount : VolBackups } - { size : 100 , id : backups-data , dev : VolBackups , format : xfs , mount : /pgbackups } - { size : 51 , id : wal , dev : /dev/xvdh , format : lvm , mount : VolWAL } - { size : 50 , id : wal-share , dev : VolWAL , format : xfs , mount : /pgwal } result: 1 2 3 4 5 6 $ df -h Filesystem Size Used Avail Use% Mounted on ... /dev/mapper/VolData-_pgdata 200G 33M 200G 1 % /pgdata /dev/mapper/VolBackups-_pgbackups 100G 33M 100G 1 % /pgbackups /dev/mapper/VolWAL-_pgwal 50G 33M 50G 1 % /pgwal Warning Due to some differences in sizing it is recommended to make LVM logical volumes 1GB smaller than the physical volume Instance Volume 1 2 instance_volumes : - {} Name Default Description dev format mount","title":"Volumes"},{"location":"volumes/#storage","text":"","title":"Storage"},{"location":"volumes/#volumes","text":"1 2 volumes : - {} Name Default Description size Size in GB of the volume id The name of the volume e.g. volume it will be used as suffix dev The unique device path to use e.g. /dev/xvf , host:/nfs_mount type gp2 format Optional: Partition type e.g. xfs , lvm , nfs mount Optional: Mount point for the volume e.g. /mnt/volume","title":"Volumes"},{"location":"volumes/#lvm","text":"LVM volumes are supported are supported: To create an physical volume specify format: lvm and the volume name under mount: VolName Then add another volume with dev: VolName Example: create a 200GB volume called VolData, format it with xfs and then mount under /pgdata 1 2 3 volumes : - { size : 201 , id : data , dev : /dev/xvdf , format : lvm , mount : VolData } - { size : 200 , id : data-pgdata , dev : VolData , format : xfs , mount : /pgdata } Example: Creating 3 LVM volumes for Postgres 1 2 3 4 5 6 7 volumes : - { size : 201 , id : data , dev : /dev/xvdf , format : lvm , mount : VolData } - { size : 200 , id : data-pgdata , dev : VolData , format : xfs , mount : /pgdata } - { size : 101 , id : backups , dev : /dev/xvdg , format : lvm , mount : VolBackups } - { size : 100 , id : backups-data , dev : VolBackups , format : xfs , mount : /pgbackups } - { size : 51 , id : wal , dev : /dev/xvdh , format : lvm , mount : VolWAL } - { size : 50 , id : wal-share , dev : VolWAL , format : xfs , mount : /pgwal } result: 1 2 3 4 5 6 $ df -h Filesystem Size Used Avail Use% Mounted on ... /dev/mapper/VolData-_pgdata 200G 33M 200G 1 % /pgdata /dev/mapper/VolBackups-_pgbackups 100G 33M 100G 1 % /pgbackups /dev/mapper/VolWAL-_pgwal 50G 33M 50G 1 % /pgwal Warning Due to some differences in sizing it is recommended to make LVM logical volumes 1GB smaller than the physical volume","title":"LVM"},{"location":"volumes/#instance-volume","text":"1 2 instance_volumes : - {} Name Default Description dev format mount","title":"Instance Volume"}]}